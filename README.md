# CodeCraft2023
2023华为软件精英挑战赛（成渝赛区）：无限进步

## 成绩

| 日期   | 分数        | 说明                                   |
|------|-----------|--------------------------------------|
| 3.10 | 879,071   | baseline：实现基本行动与简单策略（距离最近）           |
| 3.11 | 1,710,141 | ①优化策略（不去买没人要的东西）；②优化机器人行走策略（先转再走，避免转圈） |
| 3.12 | 1,906,533 | 无显著优化                                |
| 3.13 | 2,695,439 | ①使用物理公式优化机器人行进；②优化策略，行进中一直检测是否可以去更好的地方 |
| 3.14 | 2,820,302 | 加入避障（墙壁和其他机器人）                       |
| 3.15 | 2,881,342 | 加入两机器人之间的优化（判断两机器人要去的地方可否交换）         |
| 3.16 | 2,650,793 | 一次决定买卖方式                             |

## 任务重述

选手程序操控4个机器人执行前进、后退、旋转、购买、出售等动作来完成物品递送任务，同时赚取差价获得利润。在运行结束时， 选手拥有的资金数即为最终分数，所获得的资金越高越好。

- 地图：地图是一个50米*50米的封闭区域。
- 坐标系：往右为X轴正方向，往上为Y轴正方向，单位为米。地图左下角坐标为原点(0,0)，右上角坐标为(50,50)。
- 物品：物品由工作台生产和收购，可由机器人在一处工作台购买物品之后出售给另一个工作台，由此产生的差价来赚取利润。
- 工作台：工作台是一个点（没有碰撞面积），坐落于地图的空地上，其作用是收购物品进行加工、并出售成品。机器人的主要任务就是在这些工作台之间流转，执行购买、运输、出售任务以获取利润。详情参考后文中的工作台机制。
- 机器人：机器人是一个半径0.45米的圆形物体，密度20 kg/m^2，可携带一个物品。由选手程序进行操控，可以执行前进、后退、旋转三种移动操作，当机器人位于工作台附近时(圆心到点的距离小于0.4米)，可以花钱购买物品或出售物品获得收益。此外，机器人可以在任意时刻销毁手中的物品（但不会获得收益）。机器人在携带物品时，其半径会变大为0.53米，由于质量=面积*密度，所以这意味着质量也会变大。

本题中总共有7种物品，分别编号为1-7。 其中1-3是原材料物品，由1-3号工作台直接产生；4-7是加工品，由4-7号工作台通过其他的物品加工而成。每一种物品都有一个购买价和原始售出价， 价格表如下表所示。

| 物品类型 | 生产配方 | 购买价 | 原始售出价 |
| -------- | -------- | ------ | ---------- |
| 1        | 无       | 3000   | 6000       |
| 2        | 无       | 4400   | 7600       |
| 3        | 无       | 5800   | 9200       |
| 4        | 1+2      | 15400  | 22500      |
| 5        | 1+3      | 17200  | 25000      |
| 6        | 2+3      | 19200  | 27500      |
| 7        | 4+5+6    | 76000  | 105000     |

物品售价计算公式

- 物品售价 =⌊物品原始售价 ∗时间价值系数 ∗碰撞价值系数 ⌋

- 设
  $$
  f(x,maxX, minRate) = \left\{ \begin{align} 
  \left[ 1 - \sqrt{1 - (1 - \frac{x}{maxX})^2} \right] \times (1 - minRate) + minRate, x < maxX \\
  minRate, x\geq maxX
  
  \end{align} \right\}
  $$

  - 时间价值系数 =f(持有帧数 ,9000,0.8)
  - 碰撞价值系数 =f(持有时累计碰撞冲量 ,1000,0.8)
  - 公式含义 物品持有时间越长，物品贬值越厉害。持有物品时碰撞的越厉害，物品贬值也越厉害。因此，想要获得高售价，就必须 更快 的 运输 ，并且持有物品时尽可能避免碰撞。如碰撞不可避免，也应当尽量减轻碰撞冲量。
  - 函数 f 当 x 越接近 0 时 其单位 x 优化所带来的 收益越高，这是考虑到 x 越接近 0 时 越难优化，因此我们给予了极限 优化更高的收益。

本题中工作台有 9 种，分别编号为 1 9 。其中 1 3 为原材料工作台，它们负责生产 1 3号原材料而不收购其他材料。 4 7 是加工工作台，收购原料的同时也生产对应的成品。8 、 9 为消耗工作台，只收购不生产 各工作台的收购原材料情况和生成物品情况 如下表所示。

| 工作台类型 | 是收购的原料编号 | 工作周期（帧数） | 生产物品 |
| ---------- | ---------------- | ---------------- | -------- |
| 1          | 无               | 3000             | 6000     |
| 2          | 无               | 4400             | 7600     |
| 3          | 无               | 5800             | 9200     |
| 4          | 1+2              | 15400            | 22500    |
| 5          | 1+3              | 17200            | 25000    |
| 6          | 2+3              | 19200            | 27500    |
| 7          | 4+5+6            | 76000            |          |

- 每个工作台根据其收购的原材料类型都有零或多个材料格，比如 7 号工作台就有 3个材料格分别用于放置 4 、 5 、 6 号物品。同时，对于会生产物品的工作台，还有一个成品格，用于放置生产出来的成品。机器人购买物品是从工作台的成品格取走物品，而出售物品则是将物品放置到对应的材料格。
- 一个物品格只能放一个对应物品，直到被清空方可继续放入下一个。例如：您无法在 7 号工作台 （材料为 4 、 5 、 6 ）放置 2 号物品，也无法在 7 号工作台已放置 4号材料的时候再放一个 4 号材料。

- 消耗型工作台 只收购原材料 、 不 生产 物品 的工作台 。 8 和 9 号工作台就属于消耗型 工作台。

- 生产型工作台 既收购原材料也 生产 物品 的工作台 。 1 7 号工作台就属于生产型工作台 。生产型工作台的工作流程如下：

1. 等待材料格物品齐备（如无需材料则跳过该步骤）。
2. 消耗所有材料格物品并进入生产周期。
3. 周期到达后，等待成品格空出来。

4. 在成品格放入成品，生产完成。
5. 重复上述过程进行下一轮生产。工作台在每帧开始的时候进行工作，因此在当前帧消耗或生产的材料，会在当前帧立刻体现出来 。

当机器人与工作台距离小于0 .4 米时 （圆心到点的距离 ），机器人可与工作台产生交互进行买卖操作。机器人最多只能身处一个工作台，倘若有附近有多个工作台满足距离小于 0 .4 米，则以最近距离工作台为准，如果一样近，那么以顺序排在前面的工作台 为准 。
由于浮点计算都存在误差，可能会导致判题器和选手程序的计算结果不一样，因此，在输入数据中，判题器会把每一个机器人的所处工作台 I D 带给选手程序，请 以此为准。

请你针对上述任务，讲讲解决方案。即如何调度四个机器人的买卖活动。



## 基本定义

- Station：工作台
- Robot：机器人



## 基本思路

将问题分为两大部分：机器人行走问题和机器人买卖策略。

### 机器人行走问题

根据题目含义，我们每一帧能控制机器人的预期角速度$[-\pi \sim \pi] \text{rad/s}$和预期前进速度$[-2 \sim 6] \text{m/s}$。

考虑其影响因素：

- 目的station的位置
- 自己当前的状态（朝向、角速度、线速度）
- 其他机器人的状态（避免碰撞）

#### 问题简化

已知在一个二维平面上，一圆形机器人的半径为$0.45\text{m}$，坐标为$(x_1, y_1)$，当前角速度为$w_0$，线速度为$\boldsymbol{v}_0$（矢量），如何控制机器人的预期角速度$\hat w$和预期前进速度$\hat v$来使其尽快且不停止地经过目的地（坐标为$(x_2, y_2)$，“经过”的判定条件是有一个时刻机器人中心与目的地间的距离小于$0.4\text{m}$）？。需要注意的是该环境尽量模拟了真实情况：机器人具有最大前进速度$6\text{m/s}$，最大后退速度$2\text{m/s}$，机器人密度$20\text{kg/m}^2$，最大旋转速度$\pi\text{/s}$，最大牵引力$250\text{N}$，最大力矩$50N\times m$。实际上，控制预期角速度和预期前进速度就是去控制牵引力和力矩。

#### 解决思路

首先仅考虑station的位置对角速度的影响。采用先转再走的形式，避免复杂的物理运算【TODO：让机器人不停止地进行运输】。具体实现上来说就是：如果station在robot的$\theta$角度上，那么如果$\text{abs}(\theta) \leq \pi / c_1$才移动，其他情况下不能移动（可以转向）。其中$c_1$是一个常数参数（代码中实现为8）。

考虑station的位置对前进速度的影响。速度先快后慢，速度计算公式如下：
$$
v = (1-e^{-d})v_{max}
$$
其中$d=((x_1-x_2)^2+(y_1 - y_2)^2)^{c_2}$，表示station和robot的距离。为了让距离远的时候可以更加快速，我们对$c_2$进行设定（欧式距离为$0.5$），代码中设为$0.8$。



### 机器人买卖策略

实际上就是选择4个robot到底谁去哪个station。

考虑其影响因素：

- station状态（坐标、剩余生产时间、原料状态、产品状态，确定`to_station`的考虑要不要换）
- robot状态（两个带着同样东西的robot不要去一个地方）

#### 问题简化

在一个二维地图上有四个机器人和一些工作台（可以购买和出售物品），你可以操纵这四个机器人前往工作台进行买卖操作。在这个过程中由于买卖价格不一样，机器人可以从中赚取利润，商品购买的价格是一定的，而出售的价格与持有时间和发生碰撞的程度有关，因此希望机器人能尽可能快并且不发生碰撞地进行移动。工作台有不同的类型，生产的物品有可能不同，出售价格不同，而且他们的生产还依赖于购买的材料，也就是说，工作台要进行生产必须保证有足够的原料。如何调度机器人前往不同的工作台（确定每个机器人前往工作台的序列）是非常重要的，你有什么想法吗？



#### 解决思路

当前买卖策略为：距离最近且可买（买了之后能卖出去）则去哪个station买；距离最近可以卖的地方。



## TODO

现在的策略还和robot的遍历有关，序号更前的可以更先被分配。这不一定合理。

精准预测时间：使用运动方程：速度、距离、朝向

【TODO】实现任务表，认领任务！

规则：

- 如果一个机器人卖给一个工作台后能直接把工作台的产品卖掉，那么就继续卖掉产品（相当于马上进入下一个任务）
- 如果一个机器人正在前往有产品的工作台，虽然可能只是去卖东西，但这个时候最好不要单独派一个机器人去专门执行这个任务。
